FROM goodsy/ddsl_cake:latest

ARG docker_stamp
ARG docker_file
RUN mkdir -p /Dockerfiles
COPY $docker_file /Dockerfiles/$docker_stamp

ENV DOCKER_MAGIC_DIR=/Volumes/Abyss/rstudio

RUN echo "root:root" | chpasswd

RUN mkdir -p /Volumes/Abyss
RUN chmod -R 777 /Volumes

COPY magic_installs /magic_installs
RUN chmod -R 777 /magic_installs
RUN cp /magic_installs/magic_init.sh /root/magic_init.sh

RUN rm -rf /home/rstudio
RUN ln -s $DOCKER_MAGIC_DIR /home/${DEFAULT_USER}

# ===========================
# Clean-up from previous installs
RUN rm -rf /var/lib/apt/lists/*
RUN rm -rf /tmp/downloaded_packages
# ===========================

RUN usermod -aG sudo ${DEFAULT_USER}
RUN echo "${DEFAULT_USER}:password" | chpasswd

# Ports for rstudio-server, shiny-server, and jupyter-notebook:
EXPOSE 8787 3838 8888 22

CMD ["/bin/bash", "/root/magic_init.sh"]
